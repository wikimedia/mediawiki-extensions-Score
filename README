Score, a MediaWiki extension for rendering musical scores with LilyPond.

Prerequisites
=============

The following packages are recommended:

* LilyPond
* Ghostscript
* ImageMagick
* FluidSynth
* LAME
* Firejail

This extension uses LilyPond to render score images, so you need a working
LilyPond installation. If you install LilyPond from a package, Ghostscript
will also be installed, since LilyPond depends on Ghostscript.

ImageMagick should be installed to trim the images, otherwise they will contain
an excessive amount of whitespace.

By default, this extension runs in a safe mode, preventing malicious code in
tags, but also preventing many of Lilypond's features. It is recommended to run
the executables from Firejail.

The extension is also capable of creating audio files from the MIDI files
generated by LilyPond. FluidSynth is used to convert MIDI files to audio files.
LAME is used to generate MP3 files.

The extension also provides a way to download MIDI file generated from the score
from the popup that is shown on score click.

This extension was tested with LilyPond 2.12.3 through 2.18.2.


Setup
=====

1. Change to the "extensions" directory of your MediaWiki installation.
2. Clone this repository.
3. Create a subdirectory named "lilypond" in your $wgUploadDirectory (usually
   the directory named "images" in in your MediaWiki directory). Make sure
   the directory is writable by your webserver. If you do not create this
   directory, the Score extension will attempt to create it for you with the
   rights available to it.
4. Add the lines

   wfLoadExtension( 'score' );
   $wgScoreTrim = true;
   $wgImageMagickConvertCommand = '/usr/bin/convert';
   $wgShellRestrictionMethod = 'firejail';

   to your LocalSettings.php file. If you get unexpected out-of-memory errors,
   you may also have to increase $wgMaxShellMemory (see

   https://www.mediawiki.org/wiki/Manual:$wgMaxShellMemory

   for more information.

By default, Score will look for binaries by their usual names in /usr/bin. If
you need to customise the locations of any of the binaries, you can copy the
lines below and change them as necessary:

$wgScoreLilyPond = '/usr/bin/lilypond';
$wgScoreAbc2Ly = '/usr/bin/abc2ly'; /* part of LilyPond */
$wgScoreFluidsynth = '/usr/bin/fluidsynth';
$wgScoreSoundfont = '/usr/share/sounds/sf2/FluidR3_GM.sf2'; /* for FluidSynth */
$wgScoreGhostScript = '/usr/bin/gs';


Usage
=====

After setup, you can use the <score>…</score> tags in your wiki markup.
For a simple score, use e.g.

<score>\relative c' { f d f a d f e d cis a cis e a g f e }</score>

This will render the appropriate score as a PNG image.

You may also specify attributes to the score tags in the general form

<score attribute1="value1" attribute2="value2">…</score>.

The following attributes are available:

* Attribute: lang
  Allowed values: ABC, lilypond (default)
  Effect: Sets the score language. For example, to provide a score in ABC
          notation, you might use

          <score lang="ABC">
          X:1
          M:C
          L:1/4
          K:C
          C, D, E, F,|G, A, B, C|D E F G|A B c d|
          e f g a|b c' d' e'|f' g' a' b'|]
          </score>.

* Attribute: override_midi
  Allowed values: Known file name, that is, if override_midi="name" is given,
                  [[File:name]] is not a redlink.
  Effect: Embeds the score image(s) into a hyperlink to a specified MIDI file.
          This is an alternative to the midi attribute (see above). It can, for
          example, be useful if you have a suitable MIDI file of superior
          quality compared with the auto-generated MIDI file the midi attribute
          yields. Of course, you can still omit both attributes in this case and
          add the file manually to the page, if you prefer.

* Attribute: override_audio
  Alias: override_ogg
  Allowed values: Known file name, that is, if override_audio="name" is given,
                  [[File:name]] is not a redlink.
  Effect: Embeds the media specified by the file name in the HTML below the
          score image(s). This is an alternative to the vorbis attribute (see
          below). Its use is similar to the use of the override_midi attribute
          (see above).

* Attribute: raw
  Effect: If included in the tag, the score code is interpreted as a complete
          LilyPond file. Use this option if you want to create more complex
          scores. If the score language (lang attribute) is not set to
          lilypond, this attribute is ignored.

* Attribute: sound
  Alias: vorbis
  Effect: If included in the tag, an audio file will be generated for the
          score, provided you installed and configured the TimedMediaHandler
          extension. An audio player will be embedded in the HTML below
          the score image(s).
